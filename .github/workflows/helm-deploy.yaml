name: Deploy with IRSA + Helm

on:
  workflow_dispatch:
    inputs:
      app:
        description: 'Select app to deploy'
        required: true
        default: 'map-api'
        type: choice
        options:
          - map-api
          - weather-api

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-northeast-2
      ROLE_NAME: mapweather-map-api-irsa-role
      SERVICE_ACCOUNT_SUBJECT: system:serviceaccount:default:map-api-sa
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 1️⃣ SSM에서 클러스터 이름 로딩
      - name: Load EKS Cluster Name from SSM
        id: get-cluster-name
        run: |
          CLUSTER_NAME=$(aws ssm get-parameter \
            --name "/mapweather/eks-cluster-name" \
            --region $AWS_REGION \
            --query "Parameter.Value" \
            --output text)
          echo "EKS_CLUSTER=$CLUSTER_NAME" >> $GITHUB_ENV

      # 2️⃣ IRSA Trust Policy 업데이트
      - name: Update IRSA Trust Policy
        run: |
          OIDC_URL=$(aws eks describe-cluster \
            --name $EKS_CLUSTER \
            --region $AWS_REGION \
            --query "cluster.identity.oidc.issuer" \
            --output text)

          OIDC_ID=$(echo $OIDC_URL | cut -d'/' -f5)

          cat > assume-policy.json <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Federated": "arn:aws:iam::863676520919:oidc-provider/oidc.eks.ap-northeast-2.amazonaws.com/id/$OIDC_ID"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "oidc.eks.ap-northeast-2.amazonaws.com/id/$OIDC_ID:sub": "$SERVICE_ACCOUNT_SUBJECT"
                  }
                }
              }
            ]
          }
          EOF

          aws iam update-assume-role-policy \
            --role-name $ROLE_NAME \
            --policy-document file://assume-policy.json

      # 3️⃣ kubeconfig 설정
      - name: Setup kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $EKS_CLUSTER

      # 4️⃣ Helm 설치
      - name: Install Helm
        uses: azure/setup-helm@v3

      # 5️⃣ Helm 배포
      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ github.event.inputs.app }} ./Charts/${{ github.event.inputs.app }} \
            --namespace default
