name: Deploy to EKS with Helm

on:
  workflow_dispatch:
    inputs:
      app:
        description: 'Select app to deploy'
        required: true
        default: 'map-api'
        type: choice
        options:
          - map-api
          - weather-api

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-northeast-2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Load EKS Cluster Name from SSM
        id: get-cluster-name
        run: |
          CLUSTER_NAME=$(aws ssm get-parameter \
            --name "/mapweather/eks-cluster-name" \
            --region $AWS_REGION \
            --query "Parameter.Value" \
            --output text)
          echo "✅ 클러스터 이름 불러옴: $CLUSTER_NAME"
          echo "EKS_CLUSTER=$CLUSTER_NAME" >> $GITHUB_ENV

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER }}

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ github.event.inputs.app }} ./chart/${{ github.event.inputs.app }} \
            --namespace default \
            --create-namespace
